# сервер на много клиентов v2
В первой версии у нас есть проблема, которую мы будем решать во второй версии: при отключении клиента от сервера в векторе ``clients`` он не удаляется.
Для решения этой проблемы мы будем реализовать механизм пингования.
## Разберем изменения
### thread
thread t3(ping_client);
Мы добавляем третий поток, в котором будет работать функция пингования.
### ping_client
```cpp
void ping_client() {
    string ping("ping");
    while (true) {
        for (int i = 0; i < clients.size(); i++) {
            Sleep(10);

            error_code ec;
            clients[i]->get_socket().write_some(asio::buffer(ping), ec);
            if (ec) {
                cout << "client disconnect" << endl;
                //block the stream
                lock_guard<mutex> lock(clients_mutex);
                clients.erase(clients.begin() + i);
            }
        }
    }
}
``` 
1. string ping("ping"); — тут мы создаем строку, которая будет отправляться клиенту, чтобы проверить, подключен ли он к серверу. Это сообщение может быть любым, в данном случае — ``ping``.
2. Далее мы создаем два цикла: первый — это бесконечный цикл, второй будет п     роходить по всем элементам вектора clients и выполнять следующие действия:
2.1. ```clients[i]->get_socket().write_some(asio::buffer(ping), ec)```Мы используем функцию get_socket, чтобы получить ссылку на сокет клиента и с помощью этой ссылки отправить сообщение клиенту.
2.2. ```if (ec)```Мы проверяем ec на наличие ошибки при отправке сообщения. Если такая ошибка есть, то мы выводим сообщение client disconnect, блокируем поток и выполняем удаление клиента из вектора clients (```clients.erase(clients.begin() + i);```), которому сообщение не удалось отправить.

Таким способом мы реализовали механизм проверки, подключен ли клиент к серверу. 
Важно: если в дальнейшем нам нужно будет обрабатывать со стороны клиента полученные данные от сервера, то нам нужно будет проверять, равна ли полученная строка строке, которую мы используем в механизме пингования, и не использовать её клиентом.